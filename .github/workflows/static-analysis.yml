name: Static Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  clang-tidy:
    name: clang-tidy Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy \
            cmake \
            ninja-build \
            libssl-dev

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS_ONLY=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        run: |
          # Run clang-tidy on source files
          find src -name '*.cpp' -not -path '*/deps/*' | \
            xargs -I {} clang-tidy {} -p build --quiet 2>&1 | \
            tee clang-tidy-output.txt

          # Check for errors
          if grep -q "error:" clang-tidy-output.txt; then
            echo "clang-tidy found errors"
            exit 1
          fi

      - name: Upload clang-tidy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-results
          path: clang-tidy-output.txt

  cppcheck:
    name: cppcheck Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=all \
            --std=c++17 \
            --suppressions-list=.cppcheck-suppressions \
            --error-exitcode=0 \
            --inline-suppr \
            --xml \
            --xml-version=2 \
            -I src \
            src 2>&1 | tee cppcheck-output.xml

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-results
          path: cppcheck-output.xml

      - name: Check cppcheck results
        run: |
          # Check for error severity issues
          if grep -q 'severity="error"' cppcheck-output.xml; then
            echo "cppcheck found error-level issues"
            grep 'severity="error"' cppcheck-output.xml
            exit 1
          fi
