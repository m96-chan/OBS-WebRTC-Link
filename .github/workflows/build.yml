name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Build Jobs - Build plugin and test binaries
  # ============================================================================

  build-linux:
    name: Build (Linux Tests)
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          libssl-dev \
          qt6-base-dev \
          libqt6core6 \
          libqt6gui6 \
          libqt6widgets6

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        test -d deps/libdatachannel && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== nlohmann-json exists: ==="
        test -d deps/nlohmann-json && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== googletest exists: ==="
        test -d deps/googletest && echo "✓ Found" || echo "✗ Not found"

    - name: Configure CMake (Tests Only)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=ON \
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cd build
        ninja datachannel-static

    - name: Build test framework
      run: |
        cd build
        ninja gtest gtest_main gmock || ninja gtest || echo "gtest built"

    - name: Build all tests
      run: |
        cd build
        ninja all

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: linux-test-binaries
        path: |
          build/tests/unit/*_test
          VERSION
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: linux-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-linux-plugin:
    name: Build Plugin (Linux)
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          libssl-dev

    - name: Install OBS Studio
      run: |
        echo "Adding OBS Studio PPA..."
        sudo add-apt-repository -y ppa:obsproject/obs-studio
        sudo apt-get update
        echo "Installing OBS Studio..."
        sudo apt-get install -y obs-studio libobs-dev
        echo "OBS Studio installed"

    - name: Verify OBS installation
      run: |
        echo "Checking OBS installation..."
        if [ -f "/usr/include/obs/obs-module.h" ]; then
          echo "✓ OBS headers found at /usr/include/obs/"
          ls -la /usr/include/obs/ | head -10
        else
          echo "✗ OBS headers not found"
          exit 1
        fi

    - name: Configure CMake (Full Plugin Build)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=OFF

    - name: Build plugin
      run: |
        cd build
        ninja obs-webrtc-link

    - name: Package plugin
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        PACKAGE_DIR="obs-webrtc-link-${VERSION}-linux-x86_64"

        mkdir -p ${PACKAGE_DIR}/lib/obs-plugins
        mkdir -p ${PACKAGE_DIR}/share/obs/obs-plugins/obs-webrtc-link

        cp build/obs-webrtc-link.so ${PACKAGE_DIR}/lib/obs-plugins/
        cp README.md ${PACKAGE_DIR}/
        cp LICENSE ${PACKAGE_DIR}/
        cp CHANGELOG.md ${PACKAGE_DIR}/

        tar czf ${PACKAGE_DIR}.tar.gz ${PACKAGE_DIR}

        echo "Package created: ${PACKAGE_DIR}.tar.gz"

    - name: Upload plugin artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-plugin
        path: obs-webrtc-link-*-linux-x86_64.tar.gz
        retention-days: 7

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        if (Test-Path deps\libdatachannel) { echo "✓ Found" } else { echo "✗ Not found" }
        echo ""
        echo "=== nlohmann-json exists: ==="
        if (Test-Path deps\nlohmann-json) { echo "✓ Found" } else { echo "✗ Not found" }
        echo ""
        echo "=== googletest exists: ==="
        if (Test-Path deps\googletest) { echo "✓ Found" } else { echo "✗ Not found" }

    - name: Configure CMake (Tests Only)
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_LIBDATACHANNEL=ON `
          -DBUILD_TESTING=ON `
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cmake --build build --config Release --target datachannel-static

    - name: Build test framework
      run: |
        cmake --build build --config Release --target gtest
        cmake --build build --config Release --target gtest_main
        cmake --build build --config Release --target gmock

    - name: Build all tests
      run: |
        cmake --build build --config Release

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-binaries
        path: |
          build/tests/unit/Release/*_test.exe
          VERSION
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-windows-plugin:
    name: Build Plugin (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install OBS Studio
      run: |
        echo "Installing OBS Studio via Chocolatey..."
        choco install obs-studio -y
        echo "OBS Studio installed"

    - name: Verify OBS installation
      run: |
        echo "Checking OBS installation..."
        $obsPath = "C:\Program Files\obs-studio"
        if (Test-Path $obsPath) {
          echo "✓ OBS Studio found at: $obsPath"
          Get-ChildItem $obsPath -Recurse -Filter "obs-module.h" | Select-Object -First 5 | ForEach-Object { echo $_.FullName }
        } else {
          echo "✗ OBS Studio not found at expected path"
          exit 1
        }

    - name: Configure CMake (Full Plugin Build)
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_LIBDATACHANNEL=ON `
          -DBUILD_TESTING=OFF

    - name: Build plugin
      run: |
        cmake --build build --config Release

    - name: Package plugin
      run: |
        $version = (Get-Content VERSION).Trim()
        $packageDir = "obs-webrtc-link-$version-windows-x64"

        New-Item -ItemType Directory -Force -Path $packageDir\obs-plugins\64bit
        New-Item -ItemType Directory -Force -Path $packageDir\data\obs-plugins\obs-webrtc-link

        Copy-Item build\Release\obs-webrtc-link.dll $packageDir\obs-plugins\64bit\
        Copy-Item README.md $packageDir\
        Copy-Item LICENSE $packageDir\
        Copy-Item CHANGELOG.md $packageDir\

        Compress-Archive -Path $packageDir\* -DestinationPath "$packageDir.zip"

        echo "Package created: $packageDir.zip"

    - name: Upload plugin artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-plugin
        path: obs-webrtc-link-*-windows-x64.zip
        retention-days: 7

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config openssl

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        test -d deps/libdatachannel && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== nlohmann-json exists: ==="
        test -d deps/nlohmann-json && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== googletest exists: ==="
        test -d deps/googletest && echo "✓ Found" || echo "✗ Not found"

    - name: Configure CMake (Tests Only)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=ON \
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cd build
        ninja datachannel-static || echo "datachannel-static not needed"
        # nlohmann_json is header-only, no build target needed

    - name: Build test framework
      run: |
        cd build
        ninja gtest gtest_main gmock || ninja gtest || echo "gtest built"

    - name: Build all tests
      run: |
        cd build
        ninja all

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-binaries
        path: |
          build/tests/unit/*_test
          VERSION
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-macos-plugin:
    name: Build Plugin (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config openssl

    - name: Install OBS Studio
      run: |
        echo "Installing OBS Studio via Homebrew..."
        brew install --cask obs
        echo "OBS Studio installed"

    - name: Verify OBS installation
      run: |
        echo "Checking OBS installation..."
        OBS_APP="/Applications/OBS.app"
        if [ -d "$OBS_APP" ]; then
          echo "✓ OBS.app found at: $OBS_APP"
          find "$OBS_APP" -name "obs-module.h" | head -5
        else
          echo "✗ OBS.app not found"
          exit 1
        fi

    - name: Configure CMake (Full Plugin Build)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=OFF

    - name: Build plugin
      run: |
        cd build
        ninja obs-webrtc-link

    - name: Package plugin
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        PACKAGE_DIR="obs-webrtc-link-${VERSION}-macos-universal"

        mkdir -p ${PACKAGE_DIR}/obs-plugins
        mkdir -p ${PACKAGE_DIR}/data/obs-plugins/obs-webrtc-link

        cp build/obs-webrtc-link.so ${PACKAGE_DIR}/obs-plugins/
        cp README.md ${PACKAGE_DIR}/
        cp LICENSE ${PACKAGE_DIR}/
        cp CHANGELOG.md ${PACKAGE_DIR}/

        tar czf ${PACKAGE_DIR}.tar.gz ${PACKAGE_DIR}

        echo "Package created: ${PACKAGE_DIR}.tar.gz"

    - name: Upload plugin artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-plugin
        path: obs-webrtc-link-*-macos-universal.tar.gz
        retention-days: 7

  # ============================================================================
  # Test Jobs - Execute tests using built binaries
  # ============================================================================

  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: build-linux

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: linux-test-binaries
        path: build

    - name: Run all unit tests
      run: |
        # Find test binaries
        TEST_DIR=$(find build -type f -name "*_test" | head -1 | xargs dirname)
        if [ -z "$TEST_DIR" ]; then
          echo "Error: No test binaries found"
          exit 1
        fi

        echo "Found test binaries in: $TEST_DIR"
        chmod +x $TEST_DIR/*_test
        cd $TEST_DIR

        EXIT_CODE=0
        for test in *_test; do
          echo "========================================"
          echo "Running $test..."
          echo "========================================"
          if ./$test --gtest_output=xml:${test}_results.xml; then
            echo "✓ $test passed"
          else
            echo "✗ $test failed"
            EXIT_CODE=1
          fi
          echo ""
        done
        exit $EXIT_CODE

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: linux-test-results
        path: |
          build/**/*_results.xml
        if-no-files-found: ignore

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: build-windows

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: windows-test-binaries
        path: build

    - name: Run all unit tests
      run: |
        # Find the actual location of test binaries
        $testDir = Get-ChildItem -Path build -Recurse -Filter "*_test.exe" | Select-Object -First 1 | Select-Object -ExpandProperty Directory
        if (-not $testDir) {
          Write-Error "No test binaries found"
          exit 1
        }

        Write-Host "Found test binaries in: $($testDir.FullName)"
        cd $testDir.FullName

        $EXIT_CODE = 0
        Get-ChildItem -Filter "*_test.exe" | ForEach-Object {
          Write-Host "========================================"
          Write-Host "Running $($_.Name)..."
          Write-Host "========================================"
          $testName = $_.BaseName
          & $_.FullName --gtest_output=xml:${testName}_results.xml
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ $($_.Name) passed"
          } else {
            Write-Host "✗ $($_.Name) failed"
            $EXIT_CODE = 1
          }
          Write-Host ""
        }
        exit $EXIT_CODE

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-results
        path: |
          build/**/*_results.xml
        if-no-files-found: ignore

  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    needs: build-macos

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: macos-test-binaries
        path: build

    - name: Run all unit tests
      run: |
        # Find test binaries
        TEST_DIR=$(find build -type f -name "*_test" | head -1 | xargs dirname)
        if [ -z "$TEST_DIR" ]; then
          echo "Error: No test binaries found"
          exit 1
        fi

        echo "Found test binaries in: $TEST_DIR"
        chmod +x $TEST_DIR/*_test
        cd $TEST_DIR

        EXIT_CODE=0
        for test in *_test; do
          echo "========================================"
          echo "Running $test..."
          echo "========================================"
          if ./$test --gtest_output=xml:${test}_results.xml; then
            echo "✓ $test passed"
          else
            echo "✗ $test failed"
            EXIT_CODE=1
          fi
          echo ""
        done
        exit $EXIT_CODE

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-results
        path: |
          build/**/*_results.xml
        if-no-files-found: ignore

  # ============================================================================
  # Summary Job - Aggregate results
  # ============================================================================

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, test-linux, test-windows, test-macos]
    if: always()

    steps:
    - name: Download Linux plugin
      if: needs.build-linux.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: linux-plugin
        path: artifacts

    - name: Check results
      run: |
        echo "# CI/CD Pipeline Summary"
        echo ""
        echo "## Build Results"
        echo "- Linux:   ${{ needs.build-linux.result }}"
        echo "- Windows: ${{ needs.build-windows.result }}"
        echo "- macOS:   ${{ needs.build-macos.result }}"
        echo ""
        echo "## Test Results"
        echo "- Linux:   ${{ needs.test-linux.result }}"
        echo "- Windows: ${{ needs.test-windows.result }}"
        echo "- macOS:   ${{ needs.test-macos.result }}"
        echo ""
        echo "## Build Artifacts"
        if [ -f artifacts/obs-webrtc-link.so ]; then
          echo "✓ Linux plugin binary: obs-webrtc-link.so"
        else
          echo "✗ Linux plugin binary not found"
        fi
        echo ""
        echo "## Notes"
        echo "- Linux builds full plugin with OBS SDK"
        echo "- Windows/macOS build tests only (OBS SDK not available)"
        echo "- This workflow validates:"
        echo "  ✓ OBS SDK compilation and caching"
        echo "  ✓ Plugin compilation (Linux)"
        echo "  ✓ Dependency compilation (all platforms)"
        echo "  ✓ Cross-platform CMake configuration"
        echo "  ✓ Unit test compilation and execution"
        echo ""

        # Fail the summary job if any build or test failed
        if [[ "${{ needs.build-linux.result }}" != "success" ]] || \
           [[ "${{ needs.build-windows.result }}" != "success" ]] || \
           [[ "${{ needs.build-macos.result }}" != "success" ]] || \
           [[ "${{ needs.test-linux.result }}" != "success" ]] || \
           [[ "${{ needs.test-windows.result }}" != "success" ]] || \
           [[ "${{ needs.test-macos.result }}" != "success" ]]; then
          echo "❌ Some jobs failed"
          exit 1
        else
          echo "✅ All jobs passed"
        fi
