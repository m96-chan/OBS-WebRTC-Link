name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Build OBS SDK Jobs - Build OBS Studio SDK for plugin compilation
  # ============================================================================

  build-obs-linux:
    name: Build OBS SDK (Linux)
    runs-on: ubuntu-22.04

    steps:
    - name: Cache OBS Studio SDK
      id: cache-obs
      uses: actions/cache@v4
      with:
        path: obs-studio/build/install
        key: obs-sdk-linux-30.2.0

    - name: Install OBS dependencies
      if: steps.cache-obs.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          qtbase5-dev \
          libqt5svg5-dev \
          libavcodec-dev \
          libavdevice-dev \
          libavfilter-dev \
          libavformat-dev \
          libavutil-dev \
          libswresample-dev \
          libswscale-dev \
          libx264-dev \
          libcurl4-openssl-dev \
          libmbedtls-dev \
          libgl1-mesa-dev \
          libjansson-dev \
          libluajit-5.1-dev \
          python3-dev \
          libx11-dev \
          libxcb-xinput-dev \
          libxcb-randr0-dev \
          libxcb-xfixes0-dev \
          libx11-xcb-dev \
          libxcb1-dev \
          libxcb-keysyms1-dev \
          libxcb-shm0-dev \
          libxcb-xinerama0-dev \
          libasound2-dev \
          libpulse-dev \
          libwayland-dev \
          libdrm-dev \
          uthash-dev \
          libxkbcommon-dev \
          libxcb-composite0-dev \
          libv4l-dev

    - name: Build OBS Studio SDK
      if: steps.cache-obs.outputs.cache-hit != 'true'
      run: |
        git clone --recursive https://github.com/obsproject/obs-studio.git
        cd obs-studio
        git checkout 30.2.0

        # Create CMake preset for minimal SDK build
        cat > CMakeUserPresets.json << 'PRESET_EOF'
        {
          "version": 3,
          "configurePresets": [
            {
              "name": "ci-linux-minimal",
              "displayName": "Linux Minimal SDK",
              "binaryDir": "${sourceDir}/build",
              "generator": "Ninja",
              "cacheVariables": {
                "CMAKE_BUILD_TYPE": "Release",
                "CMAKE_INSTALL_PREFIX": "${sourceDir}/build/install",
                "ENABLE_BROWSER": false,
                "ENABLE_WEBSOCKET": false,
                "ENABLE_SCRIPTING": false,
                "ENABLE_UI": false,
                "BUILD_TESTS": false,
                "ENABLE_PLUGINS": false,
                "ENABLE_AJA": false,
                "ENABLE_ALSA": false,
                "ENABLE_JACK": false,
                "ENABLE_PIPEWIRE": false,
                "ENABLE_PULSEAUDIO": false,
                "ENABLE_V4L2": false,
                "ENABLE_VLC": false,
                "ENABLE_WAYLAND": false
              }
            }
          ]
        }
        PRESET_EOF

        cmake --preset ci-linux-minimal
        cmake --build build --target obs-frontend-api
        cmake --build build --target install

    - name: Upload OBS SDK
      uses: actions/upload-artifact@v4
      with:
        name: obs-sdk-linux
        path: obs-studio/build/install
        retention-days: 1

  # ============================================================================
  # Build Jobs - Build plugin and test binaries
  # ============================================================================

  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-22.04
    needs: build-obs-linux

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          libssl-dev

    - name: Download OBS SDK
      uses: actions/download-artifact@v4
      with:
        name: obs-sdk-linux
        path: obs-sdk

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        test -d deps/libdatachannel && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== nlohmann-json exists: ==="
        test -d deps/nlohmann-json && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== googletest exists: ==="
        test -d deps/googletest && echo "✓ Found" || echo "✗ Not found"

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=ON \
          -DOBS_INCLUDE_SEARCH_PATH=$PWD/obs-sdk/include \
          -DOBS_LIB_SEARCH_PATH=$PWD/obs-sdk/lib

    - name: Build dependencies
      run: |
        cd build
        ninja datachannel-static
        # nlohmann_json is header-only, no build target needed

    - name: Build test framework
      run: |
        cd build
        ninja gtest gtest_main gmock || ninja gtest || echo "gtest built"

    - name: Build plugin
      run: |
        cd build
        ninja obs-webrtc-link

    - name: Build all tests
      run: |
        cd build
        ninja all

    - name: Upload plugin binary
      uses: actions/upload-artifact@v4
      with:
        name: linux-plugin
        path: build/obs-webrtc-link.so
        retention-days: 7

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: linux-test-binaries
        path: |
          build/tests/unit/*_test
          build/Testing/
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: linux-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        if (Test-Path deps\libdatachannel) { echo "✓ Found" } else { echo "✗ Not found" }
        echo ""
        echo "=== nlohmann-json exists: ==="
        if (Test-Path deps\nlohmann-json) { echo "✓ Found" } else { echo "✗ Not found" }
        echo ""
        echo "=== googletest exists: ==="
        if (Test-Path deps\googletest) { echo "✓ Found" } else { echo "✗ Not found" }

    - name: Configure CMake (Tests Only)
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_LIBDATACHANNEL=ON `
          -DBUILD_TESTING=ON `
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cmake --build build --config Release --target datachannel-static

    - name: Build test framework
      run: |
        cmake --build build --config Release --target gtest
        cmake --build build --config Release --target gtest_main
        cmake --build build --config Release --target gmock

    - name: Build all tests
      run: |
        cmake --build build --config Release

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-binaries
        path: |
          build/tests/unit/Release/*_test.exe
          build/Testing/
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config openssl

    - name: Check submodules
      run: |
        echo "=== Checking Git Submodules ==="
        git submodule status
        echo ""
        echo "=== libdatachannel exists: ==="
        test -d deps/libdatachannel && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== nlohmann-json exists: ==="
        test -d deps/nlohmann-json && echo "✓ Found" || echo "✗ Not found"
        echo ""
        echo "=== googletest exists: ==="
        test -d deps/googletest && echo "✓ Found" || echo "✗ Not found"

    - name: Configure CMake (Tests Only)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTING=ON \
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cd build
        ninja datachannel-static || echo "datachannel-static not needed"
        # nlohmann_json is header-only, no build target needed

    - name: Build test framework
      run: |
        cd build
        ninja gtest gtest_main gmock || ninja gtest || echo "gtest built"

    - name: Build all tests
      run: |
        cd build
        ninja all

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-binaries
        path: |
          build/tests/unit/*_test
          build/Testing/
        retention-days: 1

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-build-logs
        path: |
          build/CMakeFiles/CMakeOutput.log
          build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  # ============================================================================
  # Test Jobs - Execute tests using built binaries
  # ============================================================================

  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: build-linux

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: linux-test-binaries
        path: build

    - name: Set executable permissions
      run: |
        chmod +x build/tests/unit/*_test

    - name: Run all tests with CTest
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: linux-test-results
        path: |
          build/Testing/**/*.xml
        if-no-files-found: ignore

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: build-windows

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: windows-test-binaries
        path: build

    - name: Run all tests with CTest
      run: |
        cd build
        ctest -C Release --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-results
        path: |
          build/Testing/**/*.xml
        if-no-files-found: ignore

  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    needs: build-macos

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: macos-test-binaries
        path: build

    - name: Set executable permissions
      run: |
        chmod +x build/tests/unit/*_test

    - name: Run all tests with CTest
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-results
        path: |
          build/Testing/**/*.xml
        if-no-files-found: ignore

  # ============================================================================
  # Summary Job - Aggregate results
  # ============================================================================

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, test-linux, test-windows, test-macos]
    if: always()

    steps:
    - name: Download Linux plugin
      if: needs.build-linux.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: linux-plugin
        path: artifacts

    - name: Check results
      run: |
        echo "# CI/CD Pipeline Summary"
        echo ""
        echo "## Build Results"
        echo "- Linux:   ${{ needs.build-linux.result }}"
        echo "- Windows: ${{ needs.build-windows.result }}"
        echo "- macOS:   ${{ needs.build-macos.result }}"
        echo ""
        echo "## Test Results"
        echo "- Linux:   ${{ needs.test-linux.result }}"
        echo "- Windows: ${{ needs.test-windows.result }}"
        echo "- macOS:   ${{ needs.test-macos.result }}"
        echo ""
        echo "## Build Artifacts"
        if [ -f artifacts/obs-webrtc-link.so ]; then
          echo "✓ Linux plugin binary: obs-webrtc-link.so"
        else
          echo "✗ Linux plugin binary not found"
        fi
        echo ""
        echo "## Notes"
        echo "- Linux builds full plugin with OBS SDK"
        echo "- Windows/macOS build tests only (OBS SDK not available)"
        echo "- This workflow validates:"
        echo "  ✓ OBS SDK compilation and caching"
        echo "  ✓ Plugin compilation (Linux)"
        echo "  ✓ Dependency compilation (all platforms)"
        echo "  ✓ Cross-platform CMake configuration"
        echo "  ✓ Unit test compilation and execution"
        echo ""

        # Fail the summary job if any build or test failed
        if [[ "${{ needs.build-linux.result }}" != "success" ]] || \
           [[ "${{ needs.build-windows.result }}" != "success" ]] || \
           [[ "${{ needs.build-macos.result }}" != "success" ]] || \
           [[ "${{ needs.test-linux.result }}" != "success" ]] || \
           [[ "${{ needs.test-windows.result }}" != "success" ]] || \
           [[ "${{ needs.test-macos.result }}" != "success" ]]; then
          echo "❌ Some jobs failed"
          exit 1
        else
          echo "✅ All jobs passed"
        fi
