name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  # ============================================================================
  # Build OBS SDK for Linux (needed for plugin build)
  # ============================================================================

  build-obs-linux:
    name: Build OBS SDK (Linux)
    runs-on: ubuntu-22.04

    steps:
    - name: Cache OBS Studio SDK
      id: cache-obs
      uses: actions/cache@v4
      with:
        path: obs-studio/build/install
        key: obs-sdk-linux-30.2.0

    - name: Install OBS dependencies
      if: steps.cache-obs.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          qtbase5-dev \
          libqt5svg5-dev \
          libavcodec-dev \
          libavdevice-dev \
          libavfilter-dev \
          libavformat-dev \
          libavutil-dev \
          libswresample-dev \
          libswscale-dev \
          libx264-dev \
          libcurl4-openssl-dev \
          libmbedtls-dev \
          libgl1-mesa-dev \
          libjansson-dev \
          libluajit-5.1-dev \
          python3-dev \
          libx11-dev \
          libxcb-xinput-dev \
          libxcb-randr0-dev \
          libxcb-xfixes0-dev \
          libx11-xcb-dev \
          libxcb1-dev \
          libxcb-keysyms1-dev \
          libxcb-shm0-dev \
          libxcb-xinerama0-dev \
          libasound2-dev \
          libpulse-dev \
          libwayland-dev \
          libdrm-dev \
          uthash-dev \
          libxkbcommon-dev \
          libxcb-composite0-dev \
          libv4l-dev

    - name: Build OBS Studio SDK
      if: steps.cache-obs.outputs.cache-hit != 'true'
      run: |
        git clone --recursive https://github.com/obsproject/obs-studio.git
        cd obs-studio
        git checkout 30.2.0

        # Create CMake preset for minimal SDK build
        cat > CMakeUserPresets.json << 'PRESET_EOF'
        {
          "version": 3,
          "configurePresets": [
            {
              "name": "ci-linux-minimal",
              "displayName": "Linux Minimal SDK",
              "binaryDir": "${sourceDir}/build",
              "generator": "Ninja",
              "cacheVariables": {
                "CMAKE_BUILD_TYPE": "Release",
                "CMAKE_INSTALL_PREFIX": "${sourceDir}/build/install",
                "ENABLE_BROWSER": false,
                "ENABLE_WEBSOCKET": false,
                "ENABLE_SCRIPTING": false,
                "ENABLE_UI": false,
                "BUILD_TESTS": false,
                "ENABLE_PLUGINS": false,
                "ENABLE_AJA": false,
                "ENABLE_ALSA": false,
                "ENABLE_JACK": false,
                "ENABLE_PIPEWIRE": false,
                "ENABLE_PULSEAUDIO": false,
                "ENABLE_V4L2": false,
                "ENABLE_VLC": false,
                "ENABLE_WAYLAND": false
              }
            }
          ]
        }
        PRESET_EOF

        cmake --preset ci-linux-minimal
        cmake --build build --target obs-frontend-api
        cmake --build build --target install

    - name: Upload OBS SDK
      uses: actions/upload-artifact@v4
      with:
        name: obs-sdk-linux
        path: obs-studio/build/install
        retention-days: 1

  # ============================================================================
  # Build Plugin Binaries
  # ============================================================================

  build-linux:
    name: Build Plugin (Linux)
    runs-on: ubuntu-22.04
    needs: build-obs-linux

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ninja-build \
          pkg-config \
          libssl-dev \
          qt6-base-dev \
          libqt6core6 \
          libqt6gui6 \
          libqt6widgets6

    - name: Download OBS SDK
      uses: actions/download-artifact@v4
      with:
        name: obs-sdk-linux
        path: obs-sdk

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DOBS_INCLUDE_SEARCH_PATH=$PWD/obs-sdk/include \
          -DOBS_LIB_SEARCH_PATH=$PWD/obs-sdk/lib

    - name: Build plugin
      run: |
        cd build
        ninja obs-webrtc-link

    - name: Get version
      id: version
      run: echo "version=$(cat VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

    - name: Create release package
      run: |
        mkdir -p release/obs-webrtc-link
        cp build/obs-webrtc-link.so release/obs-webrtc-link/
        cp VERSION release/obs-webrtc-link/
        cp README.md release/obs-webrtc-link/
        cp CHANGELOG.md release/obs-webrtc-link/
        cd release
        tar -czf obs-webrtc-link-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz obs-webrtc-link/

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: obs-webrtc-link-linux
        path: release/*.tar.gz
        retention-days: 7

  build-windows:
    name: Build Plugin (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake (Tests Only - No OBS SDK on Windows CI)
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_LIBDATACHANNEL=ON `
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cmake --build build --config Release --target datachannel-static

    - name: Get version
      id: version
      shell: pwsh
      run: |
        $version = (Get-Content VERSION).Trim()
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Create release info
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release
        @"
        # OBS WebRTC Link v${{ steps.version.outputs.version }} - Windows

        Note: Windows plugin binary requires local build with OBS Studio SDK.
        Please refer to BUILD.md for instructions on building for Windows.

        This release includes:
        - Source code
        - Documentation
        - Build instructions

        ## Building for Windows

        See BUILD.md for detailed instructions on building the plugin for Windows
        with the OBS Studio SDK.
        "@ | Out-File -FilePath release/WINDOWS_BUILD_NOTES.txt -Encoding UTF8

        Copy-Item VERSION release/
        Copy-Item README.md release/
        Copy-Item BUILD.md release/
        Copy-Item CHANGELOG.md release/

    - name: Create release package
      shell: pwsh
      run: |
        Compress-Archive -Path release/* -DestinationPath "release/obs-webrtc-link-${{ steps.version.outputs.version }}-windows-source.zip"

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: obs-webrtc-link-windows
        path: release/*.zip
        retention-days: 7

  build-macos:
    name: Build Plugin (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config openssl

    - name: Configure CMake (Tests Only - No OBS SDK on macOS CI)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_LIBDATACHANNEL=ON \
          -DBUILD_TESTS_ONLY=ON

    - name: Build dependencies
      run: |
        cd build
        ninja datachannel-static || echo "datachannel-static not needed"

    - name: Get version
      id: version
      run: echo "version=$(cat VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

    - name: Create release info
      run: |
        mkdir -p release
        cat > release/MACOS_BUILD_NOTES.txt << 'EOF'
        # OBS WebRTC Link v${{ steps.version.outputs.version }} - macOS

        Note: macOS plugin binary requires local build with OBS Studio SDK.
        Please refer to BUILD.md for instructions on building for macOS.

        This release includes:
        - Source code
        - Documentation
        - Build instructions

        ## Building for macOS

        See BUILD.md for detailed instructions on building the plugin for macOS
        with the OBS Studio SDK.
        EOF

        cp VERSION release/
        cp README.md release/
        cp BUILD.md release/
        cp CHANGELOG.md release/

    - name: Create release package
      run: |
        cd release
        zip -r obs-webrtc-link-${{ steps.version.outputs.version }}-macos-source.zip *

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: obs-webrtc-link-macos
        path: release/*.zip
        retention-days: 7

  # ============================================================================
  # Create GitHub Release
  # ============================================================================

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "version=${${{ github.event.inputs.tag }}#v}" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts

    - name: Extract release notes from CHANGELOG
      id: extract_notes
      run: |
        # Extract the section for this version from CHANGELOG.md
        VERSION="${{ steps.version.outputs.version }}"

        # Get content between version header and next version or end
        NOTES=$(awk "/^## \[$VERSION\]/,/^## \[/" CHANGELOG.md | head -n -1 | tail -n +2)

        # If no specific version notes found, use Unreleased section
        if [ -z "$NOTES" ]; then
          NOTES=$(awk '/^## \[Unreleased\]/,/^## \[/' CHANGELOG.md | head -n -1 | tail -n +2)
        fi

        # Save to file for use in release
        echo "$NOTES" > release_notes.md

        # Add download links
        echo "" >> release_notes.md
        echo "## Downloads" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **Linux**: \`obs-webrtc-link-$VERSION-linux-x86_64.tar.gz\`" >> release_notes.md
        echo "- **Windows**: \`obs-webrtc-link-$VERSION-windows-source.zip\` (requires local build)" >> release_notes.md
        echo "- **macOS**: \`obs-webrtc-link-$VERSION-macos-source.zip\` (requires local build)" >> release_notes.md
        echo "" >> release_notes.md
        echo "See [BUILD.md](https://github.com/${{ github.repository }}/blob/main/BUILD.md) for build instructions." >> release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
        files: |
          artifacts/obs-webrtc-link-linux/*.tar.gz
          artifacts/obs-webrtc-link-windows/*.zip
          artifacts/obs-webrtc-link-macos/*.zip
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Summary
  # ============================================================================

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "# Release Summary"
        echo ""
        echo "Release created successfully!"
        echo ""
        echo "- Linux plugin binary: ✓"
        echo "- Windows source package: ✓"
        echo "- macOS source package: ✓"
        echo "- GitHub Release: ✓"
        echo ""
        echo "The release is now available at:"
        echo "https://github.com/${{ github.repository }}/releases"
