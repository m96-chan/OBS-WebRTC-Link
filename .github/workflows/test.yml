name: Run Tests

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: linux-test-binaries
        path: build
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Set executable permissions
      run: |
        chmod +x build/tests/unit/*_test

    - name: Run all tests with CTest
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: linux-test-results
        path: |
          build/test-results.xml
          build/Testing/**/*.xml
        if-no-files-found: ignore

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: windows-test-binaries
        path: build
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Run all tests with CTest
      run: |
        cd build
        ctest -C Release --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: windows-test-results
        path: |
          build/tests/unit/Release/test-results.xml
          build/Testing/**/*.xml
        if-no-files-found: ignore

  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Download test binaries
      uses: actions/download-artifact@v4
      with:
        name: macos-test-binaries
        path: build
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Set executable permissions
      run: |
        chmod +x build/tests/unit/*_test

    - name: Run all tests with CTest
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-test-results
        path: |
          build/test-results.xml
          build/Testing/**/*.xml
        if-no-files-found: ignore

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-linux, test-windows, test-macos]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "# Test Results Summary"
        echo ""
        echo "## Test Results"
        echo "- Linux:   ${{ needs.test-linux.result }}"
        echo "- Windows: ${{ needs.test-windows.result }}"
        echo "- macOS:   ${{ needs.test-macos.result }}"
        echo ""
        echo "## Notes"
        echo "- Test failures do not block merging"
        echo "- Review test results to ensure quality"
        echo "- This workflow runs automatically after successful builds"
